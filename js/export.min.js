/*
 * Copyright © 2014 by Steve Muller. All rights reserved.
 * You may not copy, reproduce, alter, create derivates of, redistribute or sell this work without
 * explicit permission of the author. This copyright notice must not be removed.
 *
 */
function init_export(e,t){function s(e){function u(e,t){$("<strong/>").appendTo(e).text(t.name);$("<em/>").appendTo(e).text(n[t.rod]+", "+lang("$/$ species").replace(/\$/,t.fishes.length).replace(/\$/,r[t.rod]))}function a(){$(this).closest("tr").remove();var e=$(this).data("toon");if(!e.id){e.id=(new Date).valueOf();e.name+=lang(" (copy)")}else{e.id=parseInt(e.id)}var t=localStorage.toons?JSON.parse(localStorage.toons):{};t[e.id]=e;localStorage.toons=JSON.stringify(t)}var t=$("<table/>").addClass("importtable").appendTo(e);var i=$("<tr/>").appendTo($("<thead/>").appendTo(t));$("<th/>").appendTo(i).text(lang("Toon to be imported"));$("<th/>").appendTo(i).text(lang("Existing toon"));$("<th/>").appendTo(i).text(lang("Actions"));var s=$("<tbody/>").appendTo(t);var f=localStorage.toons?JSON.parse(localStorage.toons):{};var l=o(atob(e.data("import")));for(var c=0;c<l.length;c++){var h=$("<tr/>").appendTo(s);var p=$("<td/>").appendTo(h);u(p,l[c]);var d=$("<td/>").appendTo(h);var v=$("<td/>").appendTo(h);if(l[c].id in f){u(d,f[l[c].id]);var m=$.extend({},l[c],{id:0});$("<button/>").appendTo(v).text(lang("Replace")).attr("data-toon",JSON.stringify(l[c])).click(a);$("<button/>").appendTo(v).text(lang("Create copy")).attr("data-toon",JSON.stringify(m)).click(a)}else{d.text(lang("No matching toon found"));$("<button/>").appendTo(v).text(lang("Import")).attr("data-toon",JSON.stringify(l[c])).click(a)}}}function o(e){var t=[];while(e.length>0){var n=e.indexOf("	");var r=e.indexOf("	",n+1);if(n<0||r<0)break;var s={};s.id=e.substring(0,n);s.name=e.substring(n+1,r);s.rod=e.substr(r+1,2);s.fishes=[];for(var n=0;n<i.length;n++){var o=e.charCodeAt(r+3+(n-n%8)/8)>>n%8&1;if(o)s.fishes.push(i[n])}t.push(s);e=e.substring(r+4+(i.length-1-(i.length-1)%8)/8)}return t}function u(e){$('<input type="text"/>').appendTo(e).css({width:"600px",font:"inherit"}).attr("readonly","readonly");var t=$("<ul/>").addClass("sharelist").appendTo(e);$("<a/>").appendTo($("<li/>").appendTo(t)).attr("id","sendpermail").attr("href","").text(lang("Send this link via e-mail"))}function a(e){}function f(n){function o(){var n="";r.find("input:checked").each(function(){var e=$(this).attr("name");var t=s[e];n+=t.id+"	"+t.name.replace(/\t/g," ")+"	"+t.rod;var r=0;for(var o=0;o<i.length;o++){if(t.fishes.indexOf(i[o])>=0)r|=1<<o%8;if((o+1)%8==0||o+1==i.length){n+=String.fromCharCode(r);r=0}}});n=encodeURIComponent(btoa(n));$("#toons_export_url_control input").val(e+"?data="+n);$("#toons_export_url_control #sendpermail").attr("href","mailto:?subject="+encodeURIComponent(lang("Fish Advisor: Import data"))+"&body="+encodeURIComponent(e+"?data="+n));$("#toons_export_qr_control").empty();$("<img/>").appendTo("#toons_export_qr_control").attr("src",t+"?data="+n).css("opacity","0").load(function(){$(this).css("opacity","1")})}var r=$("<ul/>").addClass("exporttoonlist").appendTo(n);var s=localStorage.toons?JSON.parse(localStorage.toons):{};for(var u in s){var a=$("<li/>").appendTo(r);var f=$("<label/>").appendTo(a);$('<input type="checkbox"/>').appendTo(f).change(o).attr("name",u).attr("value","1").attr("checked","checked");$("<span/>").appendTo(f).text(s[u].name)}o()}var n={tg:lang("Twig"),bm:lang("Bamboo"),hw:lang("Hardwood"),st:lang("Steel"),gd:lang("Gold")};var r={tg:38,bm:49,hw:60,st:69,gd:70};var i=[0,1,2,3,4,512,513,514,515,516,32,33,34,35,36,64,65,66,67,96,128,129,130,131,132,160,192,193,194,195,196,544,224,225,256,257,258,288,289,290,320,321,322,323,324,325,352,353,354,355,384,385,386,387,416,417,418,419,420,421,422,423,448,449,450,480,481,482,483,484];$("#toons_export_url_control").each(function(){u($(this))});$("#toons_export_qr_control").each(function(){a($(this))});$("#toons_export_control").each(function(){f($(this))});$("#toons_import_control").each(function(){s($(this))})}